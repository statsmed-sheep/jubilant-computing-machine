---
title: "Data Analysis & Modelling"
author: "Rose Porta and Clara Li"
date: "05/16/2020"
output: html_document
---
```{r}
data <- read.csv("data.csv")

library(tidyverse)
library(broom)
library(gtools)
```

# Logistic Model
```{r}
# Fit full logistic model
model_full <- glm(chronic ~ HRSLEEP + depfreq_often + depfreq_monthly + I(HRSLEEP*depfreq_often) + I(HRSLEEP*depfreq_monthly) + log(AGE) + SEX + BMI + activity_score + income_high + income_middle + race_asian + race_black + race_na, family = binomial, data = data)

summary(model_full)

# Data 1: only women
data1 <- data %>% 
  filter(SEX == 1)

model_women <- glm(chronic ~ HRSLEEP + depfreq_often + depfreq_monthly + I(HRSLEEP*depfreq_often) + I(HRSLEEP*depfreq_monthly) + log(AGE) + SEX + BMI + activity_score + income_high + income_middle + race_asian + race_black + race_na, family = binomial, data = data1)

summary(model_women)

# Results for data1:
# HRSLEEP significant at 0.10 level, p-value = 0.094166
# depfreq_often significant at 0.01 level, p-value = 0.003030
# I(HRSLEEP * depfreq_often) significant at 0.05 level, p-value = 0.031241

# Data 2: only men
data2 <- data %>% 
  filter(SEX == 0)

model_men <- glm(chronic ~ HRSLEEP + depfreq_often + depfreq_monthly + I(HRSLEEP*depfreq_often) + I(HRSLEEP*depfreq_monthly) + log(AGE) + SEX + BMI + activity_score + income_high + income_middle + race_asian + race_black + race_na, family = binomial, data = data2)

summary(model_men)

# Result for data2: nothing of interest is significant

# Fit model without confounders

model_simple <- glm(chronic ~ HRSLEEP + depfreq_often + depfreq_monthly, data = data, family = binomial)

summary(model_simple)
            
```


## Checking Regression Assumptions: 

# Linearity

The empirical logit plot seems approximately linear.

```{r, warning = FALSE, message = FALSE}
# Code from 18-simplelogistic-lab activity to generate x and y values for plot to check for linearity
data_bin <- data %>%
  # Break HRSLEEP into 10 bins
  mutate(HRSLEEP_group = cut(HRSLEEP, breaks=10)) %>% 
  group_by(HRSLEEP_group) %>%
  # calculate mean HRSLEEP value and proportion obese in each bin
  mutate(binned.y = mean(chronic), binned.x = mean(HRSLEEP)) %>% 
  # transform binned.y from proportion to log(odds)
  mutate(binned.y_logit = logit(binned.y))

# Create plot of log(odds) verus age
ggplot(data_bin, aes(x = binned.x, y = binned.y_logit)) +
  geom_point() + 
  geom_smooth(method = lm, se = FALSE)
```
## Randomness

Obviously, individuals are not assigned BMIs by a spinner model, but since we have a random sample, the randomness assumption is met.

## Independence

As established above for the linear regression model, the independence assumption is reasonable for this data set.

```{r}
data.cor = cor(data)
```

# Significance Tests: 

## Z-test for slope: 

$\beta_1$: 

$H_0: \beta_1 = 0$ 

$H_a: \beta_1 \ne 0$

$\alpha = 0.05$

z-value = 0.358  

p-value = 0.72002

Since our p-value of 0.72002 is more than 0.05, we fail to reject the null hypothesis that there is no significant relationship between the number of hours of sleep and individual gets per night and their likelihood of having diabetes, adjusting for depression frequency and the rest of our confounding variables. 

$\beta_2$: 

$H_0: \beta_2 = 0$ 

$H_a: \beta_2 \ne 0$

$\alpha = 0.05$

z-value = 2.928 

p-value = 0.00341

Since our p-value of 0.00341 is less than 0.05, we have strong evidence to reject the null hypothesis and conclude that on average, adjusting for hours of sleep and the rest of our confounding variables, an individual's likelihood of having diabetes differs depending on whether they feel depressed daily/weekly or not. 

$\beta_3$: 

$H_0: \beta_3 = 0$ 

$H_a: \beta_3 \ne 0$

$\alpha = 0.05$

z-value = 0.456    

p-value = 0.64860

Since our p-value of 0.64860 is more than 0.05, we fail to reject the null hypothesis that on average, adjusting for hours of sleep and the rest of our confounding variables, an individual's likelihood of having diabetes does not differ depending on whether they feel depressed monthly or not. 

$\beta_4$: 

$H_0: \beta_4 = 0$ 

$H_a: \beta_4 \ne 0$

$\alpha = 0.05$

z-value = -0.923    

p-value = 0.35585

Since our p-value of 0.35585 is more than 0.05, we fail to reject the null hypothesis that adjusting for our confounding variables, on average, the rate of change of an individual's odds of having diabetes as hours of sleep increases does not differ for individuals who feel depressed daily/weekly versus those who do not. 

$\beta_5$: 

$H_0: \beta_5 = 0$ 

$H_a: \beta_5 \ne 0$

$\alpha = 0.05$

z-value = 0.463   

p-value = 0.64349

Since our p-value of 0.64349 is more than 0.05, we fail to reject the null hypothesis that adjusting for our confounding variables, on average, the rate of change of an individual's odds of having diabetes as hours of sleep increases does not differ for individuals who feel depressed monthly versus those who do not. 

## 95% Confidence Intervals

```{r, message = FALSE}
exp(confint(model_logistic))
```

$\beta_1$: CI = (9.400140e-01 1.089396e+00)

We are 95% confident that for each hour increase in the number of hours and individual sleeps per night, an individual's odds of having diabetes will decrease by a factor of between 9.400140e-01 and 1.089396e+00, on average, adjusting for depression frequency and the rest of our counfounding variables. Since our confidence interval includes 1, we are not certain that there is a significant relationship between hours of sleep and likelihood of having diabetes.

$\beta_2$: CI = (1.538202e+00 8.944554e+00)

We are 95% confident that adjusting for hours of sleep and the other confounding variables, on average, the odds of having diabetes for an individual who feels depressed weekly/daily decreases by a factor between 1.538202e+00 8.944554e+00 from the odds of diabetes for an individual who does not. Since our confidence interval does not include 1, this indicates that there is a significant difference in the odds of having diabetes between individuals who feel depressed daily/weekly and those who do not. 

$\beta_3$: CI = (3.350283e-01 5.819625e+00)

We are 95% confident that adjusting for hours of sleep and the other confounding variables, on average, the odds of having diabetes for an individual who feels depressed monthly decreases by a factor between 1.538202e+00 8.944554e+00 from the odds of diabetes for an individual who does not. Since our confidence interval does not include 1, this indicates that there is a significant difference in the odds of having diabetes between individuals who feel depressed monthly and those who do not. 

$\beta_4$: CI = (8.367457e-01 1.065370e+00)

We are 95% confident that adjusting for our confounding variables, the magnitude of the average rate of change of the odds of diabetes as hours of sleep increases for an individual who feels depressed daily/weekly is between 8.367457e-01 1.065370e+00 times the rate of change of an individual who does not. Since our confidence interval does not include 1, this indicates that the average rate of change of the odds of diabetes differs significantly for individuals who feel depressed daily/weekly versus those who do not.

$\beta_5$: CI = (8.600010e-01 1.257594e+00)

We are 95% confident that adjusting for our confounding variables, the magnitude of the average rate of change of the odds of diabetes as hours of sleep increases for an individual who feels depressed monthly is between 8.600010e-01 1.257594e+00 times the rate of change of an individual who does not. Since our confidence interval includes 1, we are not certain that the average rate of change of the odds of diabetes differs significantly for individuals who feel depressed monthly versus those who do not.

## Likelihood Ratio Tests

$H_0: \beta_i = 0$ 

$H_a: \beta_i \ne 0$

$\alpha = 0.05$

```{r}
# Load necessary package
require(lmtest)

# Full model
lrtest(model_full)
```

The $-2log(L)$ values are $-2\cdot -2012.5 = 4025$ and $-2\cdot -1635.1 = 3270.2$ for the null model and full logistic model, respectively. This yields a G-statistic of 24308 - (23600) = 754.8. Compared to a chi-distribution with 14 degrees of freedom, the p-value is less than 2.2e-16, which is significant at the alpha = 0.05 level. We therefore reject the null hypothesis and conclude that the multiple logistic regression model based on sleep, depression frequency, and the interaction between sleep and depression frequency is effective at explaining the probability of being diabetic.

```{r}
# code from Logistic Regression visualization practice activity 4/20/20
preds_full <- augment(x=model_full, type.predict = "response") %>%
  mutate(lci=`.fitted`-(1.96*`.se.fit`),
         uci=`.fitted`+(1.96*`.se.fit`)) %>%
  rename(prob=`.fitted`)

probs_full<- preds_full %>%
  select(prob,lci,uci, depfreq_often, depfreq_monthly, HRSLEEP, chronic)

library(InformationValue)
Concordance(probs_full$chronic, probs_full$prob)
```
```{r}
# women
lrtest(model_women)
```

```{r}
# code from Logistic Regression visualization practice activity 4/20/20
preds_women <- augment(x=model_women, type.predict = "response") %>%
  mutate(lci=`.fitted`-(1.96*`.se.fit`),
         uci=`.fitted`+(1.96*`.se.fit`)) %>%
  rename(prob=`.fitted`)

probs_women <- preds_women %>%
  select(prob,lci,uci, depfreq_often, depfreq_monthly, HRSLEEP, chronic)

library(InformationValue)
Concordance(probs_women$chronic, probs_women$prob)
```

```{r}
# men
lrtest(model_men)
```

```{r}
# code from Logistic Regression visualization practice activity 4/20/20
preds_men <- augment(x=model_men, type.predict = "response") %>%
  mutate(lci=`.fitted`-(1.96*`.se.fit`),
         uci=`.fitted`+(1.96*`.se.fit`)) %>%
  rename(prob=`.fitted`)

probs_men <- preds_men %>%
  select(prob,lci,uci, depfreq_often, depfreq_monthly, HRSLEEP, chronic)

library(InformationValue)
Concordance(probs_men$chronic, probs_men$prob)
```

```{r}
# no confounders
lrtest(model_simple)
```

```{r}
# code from Logistic Regression visualization practice activity 4/20/20
preds_simple <- augment(x=model_simple, type.predict = "response") %>%
  mutate(lci=`.fitted`-(1.96*`.se.fit`),
         uci=`.fitted`+(1.96*`.se.fit`)) %>%
  rename(prob=`.fitted`)

probs_simple <- preds_simple %>%
  select(prob,lci,uci, depfreq_often, depfreq_monthly, HRSLEEP, chronic)

library(InformationValue)
Concordance(probs_simple$chronic, probs_simple$prob)
```
